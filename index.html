<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üíé Gem Credit Admin</title>
    <style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #0c0c0c;
    color: #eee;
    margin: 0;
    padding: 30px;
  }
  h1 { color: #00ffa2; text-align: center; margin-bottom: 10px; }
  #loginScreen, #adminScreen { display: none; }
  #loginBox {
    max-width: 350px;
    background: #1b1b1b;
    padding: 25px;
    border-radius: 10px;
    margin: 100px auto;
    text-align: center;
  }
  #loginBox input {
    width: 100%;
    background: #121212;
    color: #eee;
    border: none;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
    text-align: center;
  }
  #loginBox button {
    background: #00ffa2;
    color: #000;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    font-weight: 600;
    margin-top: 15px;
    cursor: pointer;
  }
  #credits {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
    gap: 12px;
    margin-top: 20px;
  }
  .entry {
    background: #1b1b1b;
    border-radius: 10px;
    padding: 12px 15px;
    transition: 0.2s;
  }
  .entry:hover { background: #242424; }
  .entry input, .entry textarea {
    width: 100%;
    background: #121212;
    color: #eee;
    border: none;
    border-radius: 5px;
    padding: 5px;
    margin-top: 4px;
  }
  label { font-size: 13px; color: #9f9f9f; display: block; margin-top: 6px; }
  button {
    background: #00ffa2;
    color: #000;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    padding: 7px 15px;
    cursor: pointer;
    margin-top: 10px;
    transition: 0.2s;
  }
  button:hover { opacity: 0.85; }
  #copyBtn {
    display: block;
    margin: 30px auto 0;
    font-size: 15px;
  }
  #copyMsg {
    text-align: center;
    margin-top: 10px;
    color: #00ffa2;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  /* Modal styling */
  #modalOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  #modalBox {
    background: #1b1b1b;
    padding: 25px;
    border-radius: 10px;
    max-width: 350px;
    text-align: center;
  }
  #modalBox button {
    margin: 10px;
  }
</style>
  </head>
  <body>
    <h1>üíé Gem Credit Admin</h1>

   <div style="text-align:center; margin-bottom:20px;">
  <!-- Username Lookup -->
  <div style="margin-bottom:15px;">
    <input id="usernameLookup" type="text" placeholder="Search Roblox username..." 
           style="width:250px; padding:8px; border:none; border-radius:5px; background:#121212; color:#eee; text-align:center;">
    <button id="lookupBtn" style="margin-left:8px;">Search</button>
  </div>

  <a
    href="https://docs.google.com/document/d/1c4_YmqF05y6V988r44feE2WvAR9FsBRNS7C47jHb6Mo/edit?usp=sharing"
    target="_blank" style="
    display:inline-block;
    background:#00ffa2;
    color:#000;
    font-weight:700;
    padding:10px 20px;
    border-radius:8px;
    text-decoration:none;
    transition:0.2s;
  ">
    PASTE your edits HERE!
  </a>

  <button id="copyBtn">Click to COPY your EDITS!</button>
  <div id="copyMsg">Copied!</div>
</div>

    <div id="adminScreen">
      <p style="text-align:center;color:#aaa;">Logged in as: <span
          id="currentAdmin"></span></p>
      <div id="credits"></div>

    </div>

    <div id="loginScreen">
      <div id="loginBox">
        <h2>Enter Admin Username</h2>
        <input id="adminName" placeholder="Your username" />
        <button id="loginBtn">Continue</button>
      </div>
    </div>

    <!-- Delete confirmation modal -->
    <div id="modalOverlay">
      <div id="modalBox">
        <h3 style="color:#ff6060;">Confirm Deletion</h3>
        <p id="modalText"></p>
        <button id="confirmDeleteBtn"
          style="background:#ff6060;color:#fff;">Confirm Delete</button>
        <button id="cancelDeleteBtn">Cancel</button>
      </div>
    </div>

    <script>
let credits = {};
let adminName = "";
let pendingDelete = null;
const creditsContainer = document.getElementById("credits");
const copyMsg = document.getElementById("copyMsg");
const modal = document.getElementById("modalOverlay");
const modalText = document.getElementById("modalText");

function timestamp() {
  return Math.floor(Date.now() / 1000);
}

function showLogin() {
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("adminScreen").style.display = "none";
}

function showAdmin() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("adminScreen").style.display = "block";
  document.getElementById("currentAdmin").textContent = adminName;
}

function login() {
  const nameInput = document.getElementById("adminName");
  const name = nameInput.value.trim();
  if (!name) return alert("Please enter a username");
  adminName = name;
  localStorage.setItem("adminName", name);
  showAdmin();
  loadCredits();
}

async function loadCredits() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/Haydebug/Magnet-Simulator-Crediting/main/credits.json");
    credits = await res.json();
    renderCredits();
  } catch (err) {
    alert("‚ùå Failed to load credits.json: " + err);
  }
}

function renderCredits() {
  creditsContainer.innerHTML = "";

  // ADD CREDIT CARD
  const addCard = document.createElement("div");
  addCard.className = "entry";
  addCard.innerHTML = `
    <strong style="color:#00ffa2;">‚ûï Add New Credit</strong>
    <label>User ID</label>
    <input id="userId" type="text" placeholder="e.g. 23313558" />
    <label>Amount</label>
    <input id="amount" type="number" placeholder="e.g. 250" />
    <label>Message</label>
    <textarea id="message" rows="2" placeholder="Reason for credit"></textarea>
    <button id="addBtn">Add Credit</button>
  `;
  creditsContainer.appendChild(addCard);

document.getElementById("addBtn").onclick = () => {
  let idInput = document.getElementById("userId").value.trim();
  const amt = document.getElementById("amount").value.trim();
  const msg = document.getElementById("message").value.trim();
  if (!idInput || !amt || !msg) return alert("Fill out all fields");

  // üîß Extract numeric ID if they paste a Roblox profile link (handles any format)
  const linkMatch = idInput.match(/users\/(\d+)/);
  if (linkMatch && linkMatch[1]) {
    idInput = linkMatch[1]; // use the captured numeric user ID
  }

  // ‚úÖ ensure only digits remain (safety net)
  idInput = idInput.replace(/\D/g, "");

  if (!idInput) {
    alert("Invalid Roblox user ID or link.");
    return;
  }

  const existing = credits[idInput];
  const record = {
    amount: amt,
    message: msg,
    status: "active",
    history: existing?.history || []
  };
  record.history.push({
    action: existing ? "updated" : "created",
    editor: adminName,
    timestamp: timestamp()
  });

  const newCredits = { [idInput]: record };
  for (const [k, v] of Object.entries(credits)) newCredits[k] = v;
  credits = newCredits;
  renderCredits();
};


  // EXISTING RECORDS (only show active)
  for (const [userId, data] of Object.entries(credits)) {
    if (data.status === "deleted") continue;

    const div = document.createElement("div");
    div.className = "entry";
    const historyList = (data.history || [])
      .map(h => `‚Ä¢ ${h.action} by ${h.editor || "unknown"} @ ${new Date(h.timestamp * 1000).toLocaleString()}`)
      .join("<br>");

      let lastUpdated = "";
if (data.history && data.history.length > 0) {
  const latest = data.history[data.history.length - 1];
  lastUpdated = new Date(latest.timestamp * 1000).toLocaleString();
}

    div.innerHTML = `
  <strong style="color:#00ffa2;">User ${userId}</strong>
  <div style="font-size:12px;color:#888;margin-top:3px;">Last updated: ${lastUpdated || "unknown"}</div>
  <label>Amount</label>
      <input value="${data.amount}" data-id="${userId}" data-type="amount">
      <label>Message</label>
      <textarea rows="2" data-id="${userId}" data-type="message">${data.message}</textarea>
      <button onclick="showDeleteModal('${userId}')">üóëÔ∏è Delete</button>
      <details style="margin-top:10px;"><summary>History</summary>
        <div style="margin-top:5px;font-size:12px;color:#aaa;">${historyList || "(no history)"}</div>
      </details>
    `;
    creditsContainer.appendChild(div);
  }

  creditsContainer.querySelectorAll("input, textarea").forEach(el => {
    el.addEventListener("input", e => {
      const id = e.target.dataset.id;
      const type = e.target.dataset.type;
      if (id && credits[id]) {
        credits[id][type] = e.target.value;
        credits[id].history.push({ action: "edited", editor: adminName, timestamp: timestamp() });
      }
    });
  });
}

function showDeleteModal(userId) {
  pendingDelete = userId;
  modalText.textContent = `Are you sure you want to delete credit(s) for user ${userId}?`;
  modal.style.display = "flex";
}

document.getElementById("cancelDeleteBtn").onclick = () => {
  modal.style.display = "none";
  pendingDelete = null;
};

document.getElementById("confirmDeleteBtn").onclick = () => {
  if (!pendingDelete) return;

  const id = pendingDelete;
  const entry = credits[id];
  if (!entry) {
    modal.style.display = "none";
    pendingDelete = null;
    return;
  }

  // create deleted record key before modifying credits
  const newKey = `${id}_del_${timestamp()}`;
  const deletedEntry = { ...entry }; // clone to avoid mutation confusion
  deletedEntry.status = "deleted";
  if (!deletedEntry.history) deletedEntry.history = [];
  deletedEntry.history.push({
    action: "deleted",
    editor: adminName,
    timestamp: timestamp()
  });

  // update dataset properly
  const newCredits = {};
  for (const [k, v] of Object.entries(credits)) {
    if (k !== id) newCredits[k] = v; // skip the old one
  }
  newCredits[newKey] = deletedEntry; // add the new deleted version

  credits = newCredits;

  // close modal + refresh view
  modal.style.display = "none";
  pendingDelete = null;
  renderCredits();
};

document.getElementById("copyBtn").onclick = async () => {
  const jsonText = JSON.stringify(credits, null, 4);
  try {
    await navigator.clipboard.writeText(jsonText);
    copyMsg.style.opacity = "1";
    setTimeout(() => (copyMsg.style.opacity = "0"), 1500);
  } catch (err) {
    alert("‚ùå Failed to copy JSON: " + err);
  }
};

document.getElementById("lookupBtn").onclick = () => {
  const username = document.getElementById("usernameLookup").value.trim();
  if (!username) return alert("Enter a username to search.");
  const url = `https://www.roblox.com/search/users?keyword=${encodeURIComponent(username)}`;
  window.open(url, "_blank");
};

// Auto-login if saved
const storedName = localStorage.getItem("adminName");
if (storedName) {
  adminName = storedName;
  showAdmin();
  loadCredits();
} else {
  showLogin();
}
document.getElementById("loginBtn").onclick = login;
</script>
  </body>
</html>
